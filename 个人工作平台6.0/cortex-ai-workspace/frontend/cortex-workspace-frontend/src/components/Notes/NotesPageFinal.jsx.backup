import React, { useState, useEffect } from 'react'
import { 
  Plus, 
  Search, 
  FolderPlus, 
  ChevronRight, 
  ChevronDown,
  FileText,
  Edit3,
  Trash2,
  Tag,
  Brain,
  Wand2,
  Loader2,
  Save,
  X
} from 'lucide-react'
import { Button } from '@/components/ui/button.jsx'
import { Input } from '@/components/ui/input.jsx'
import { Textarea } from '@/components/ui/textarea.jsx'
import { Badge } from '@/components/ui/badge.jsx'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card.jsx'
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog.jsx'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select.jsx'

const NotesPageFinal = () => {
  const [selectedCategory, setSelectedCategory] = useState('work')
  const [folders, setFolders] = useState({})
  const [notes, setNotes] = useState([])
  const [selectedNote, setSelectedNote] = useState(null)
  const [searchTerm, setSearchTerm] = useState('')
  const [expandedFolders, setExpandedFolders] = useState({})
  const [isEditing, setIsEditing] = useState(false)
  const [editingNote, setEditingNote] = useState(null)
  const [showAIModal, setShowAIModal] = useState(false)
  const [aiMode, setAiMode] = useState('improve')
  const [aiModel, setAiModel] = useState('openai/gpt-5')
  const [isAIProcessing, setIsAIProcessing] = useState(false)
  const [availableModels, setAvailableModels] = useState([])

  // ÂàÜÁ±ªÈÖçÁΩÆ
  const categories = [
    { id: 'work', name: 'Â∑•‰Ωú', icon: 'üíº', color: 'bg-blue-500' },
    { id: 'study', name: 'Â≠¶‰π†', icon: 'üìö', color: 'bg-green-500' },
    { id: 'life', name: 'ÁîüÊ¥ª', icon: 'üè†', color: 'bg-purple-500' }
  ]

  // AIÂ¢ûÂº∫Ê®°Âºè
  const aiModes = [
    { id: 'improve', name: 'ÊñáÊú¨ÊîπËøõ', description: '‰ºòÂåñË°®ËææÂíåËØ≠Ê≥ï' },
    { id: 'summarize', name: 'ÂÜÖÂÆπÊëòË¶Å', description: 'ÊèêÂèñÂÖ≥ÈîÆ‰ø°ÊÅØ' },
    { id: 'expand', name: 'ÂÜÖÂÆπÊâ©Â±ï', description: '‰∏∞ÂØåÁªÜËäÇÂíåÂÜÖÂÆπ' },
    { id: 'translate', name: 'Êô∫ËÉΩÁøªËØë', description: 'ÁøªËØë‰∏∫Ëã±Êñá' },
    { id: 'restructure', name: 'ÁªìÊûÑ‰ºòÂåñ', description: 'ÈáçÊñ∞ÁªÑÁªáÁªìÊûÑ' }
  ]

  // ÂàùÂßãÂåñÊï∞ÊçÆ
  useEffect(() => {
    loadAvailableModels()
    loadNotesData()
  }, [])

  // Âä†ËΩΩÂèØÁî®AIÊ®°Âûã
  const loadAvailableModels = async () => {
    try {
      const response = await fetch('/api/ai/models')
      const data = await response.json()
      setAvailableModels(data.models || [])
      if (data.default) {
        setAiModel(data.default)
      }
    } catch (error) {
      console.error('Âä†ËΩΩAIÊ®°ÂûãÂ§±Ë¥•:', error)
      // ‰ΩøÁî®ÈªòËÆ§Ê®°ÂûãÂàóË°®
      setAvailableModels([
        { id: 'openai/gpt-5', name: 'GPT-5', provider: 'OpenAI', color: 'bg-green-500' },
        { id: 'google/gemini-2.5-pro', name: 'Gemini 2.5 Pro', provider: 'Google', color: 'bg-blue-500' },
        { id: 'anthropic/claude-4', name: 'Claude-4', provider: 'Anthropic', color: 'bg-purple-500' },
        { id: 'deepseek/deepseek-chat-v3', name: 'DeepSeek V3', provider: 'DeepSeek', color: 'bg-orange-500' }
      ])
    }
  }

  // Âä†ËΩΩÁ¨îËÆ∞Êï∞ÊçÆ
  const loadNotesData = () => {
    // Ê®°ÊãüÊï∞ÊçÆ - ÂÆûÈôÖÂ∫îÁî®‰∏≠‰ªéAPIËé∑Âèñ
    const mockFolders = {
      work: [
        { id: 'w1', name: 'È°πÁõÆÊñáÊ°£', notes: ['n1', 'n2'] },
        { id: 'w2', name: '‰ºöËÆÆËÆ∞ÂΩï', notes: ['n3'] },
        { id: 'w3', name: 'ÊäÄÊúØÁ¨îËÆ∞', notes: ['n4'] }
      ],
      study: [
        { id: 's1', name: 'ReactÂ≠¶‰π†', notes: ['n5'] },
        { id: 's2', name: 'ÁÆóÊ≥ïÁªÉ‰π†', notes: ['n6'] }
      ],
      life: [
        { id: 'l1', name: 'ÂÅ•Â∫∑ÁÆ°ÁêÜ', notes: ['n7'] },
        { id: 'l2', name: 'ÊóÖË°åËÆ°Âàí', notes: ['n8'] }
      ]
    }

    const mockNotes = [
      {
        id: 'n1',
        title: 'AIÂ∑•‰ΩúÂè∞È°πÁõÆËßÑÂàí',
        content: 'È°πÁõÆÁõÆÊ†áÔºöÂºÄÂèë‰∏Ä‰∏™ÈõÜÊàêAIÂäüËÉΩÁöÑ‰∏™‰∫∫Â∑•‰ΩúÂè∞...',
        category: 'work',
        folder: 'w1',
        tags: ['È°πÁõÆ', 'AI', 'ËßÑÂàí'],
        created_at: '2024-01-15T10:00:00Z',
        updated_at: '2024-01-15T10:00:00Z'
      },
      {
        id: 'n2',
        title: 'ÊäÄÊúØÊû∂ÊûÑËÆæËÆ°',
        content: 'ÂâçÁ´ØÔºöReact + Vite\nÂêéÁ´ØÔºöFastAPI + SQLite\nAIÈõÜÊàêÔºöOpenRouter API...',
        category: 'work',
        folder: 'w1',
        tags: ['Êû∂ÊûÑ', 'ÊäÄÊúØ'],
        created_at: '2024-01-14T15:30:00Z',
        updated_at: '2024-01-14T15:30:00Z'
      },
      {
        id: 'n3',
        title: 'È°πÁõÆËøõÂ∫¶‰ºöËÆÆ',
        content: '‰ºöËÆÆÊó∂Èó¥Ôºö2024-01-15 14:00\nÂèÇ‰∏é‰∫∫ÂëòÔºöÂºÄÂèëÂõ¢Èòü\nËÆ®ËÆ∫ÂÜÖÂÆπÔºö...',
        category: 'work',
        folder: 'w2',
        tags: ['‰ºöËÆÆ', 'ËøõÂ∫¶'],
        created_at: '2024-01-15T14:00:00Z',
        updated_at: '2024-01-15T14:00:00Z'
      },
      {
        id: 'n4',
        title: 'FastAPIÊúÄ‰Ω≥ÂÆûË∑µ',
        content: 'FastAPIÊòØ‰∏Ä‰∏™Áé∞‰ª£„ÄÅÂø´ÈÄüÁöÑPython WebÊ°ÜÊû∂...',
        category: 'work',
        folder: 'w3',
        tags: ['FastAPI', 'Python', 'ÂêéÁ´Ø'],
        created_at: '2024-01-13T09:00:00Z',
        updated_at: '2024-01-13T09:00:00Z'
      },
      {
        id: 'n5',
        title: 'React HooksÊ∑±ÂÖ•ÁêÜËß£',
        content: 'useState„ÄÅuseEffect„ÄÅuseContextÁ≠âHooksÁöÑ‰ΩøÁî®...',
        category: 'study',
        folder: 's1',
        tags: ['React', 'Hooks', 'ÂâçÁ´Ø'],
        created_at: '2024-01-12T20:00:00Z',
        updated_at: '2024-01-12T20:00:00Z'
      },
      {
        id: 'n6',
        title: '‰∫åÂàÜÊü•ÊâæÁÆóÊ≥ï',
        content: '‰∫åÂàÜÊü•ÊâæÊòØ‰∏ÄÁßçÈ´òÊïàÁöÑÊêúÁ¥¢ÁÆóÊ≥ï...',
        category: 'study',
        folder: 's2',
        tags: ['ÁÆóÊ≥ï', '‰∫åÂàÜÊü•Êâæ'],
        created_at: '2024-01-11T16:00:00Z',
        updated_at: '2024-01-11T16:00:00Z'
      },
      {
        id: 'n7',
        title: 'ÂÅ•Ë∫´ËÆ°Âàí',
        content: 'ÊØèÂë®ËøêÂä®ÂÆâÊéíÔºö\nÂë®‰∏ÄÔºöË∑ëÊ≠•30ÂàÜÈíü\nÂë®‰∏âÔºöÂäõÈáèËÆ≠ÁªÉ...',
        category: 'life',
        folder: 'l1',
        tags: ['ÂÅ•Ë∫´', 'ËÆ°Âàí'],
        created_at: '2024-01-10T18:00:00Z',
        updated_at: '2024-01-10T18:00:00Z'
      },
      {
        id: 'n8',
        title: 'Êò•ËäÇÊóÖË°åËÆ°Âàí',
        content: 'ÁõÆÁöÑÂú∞Ôºö‰∫ëÂçó\nÊó∂Èó¥Ôºö2024Âπ¥2Êúà...',
        category: 'life',
        folder: 'l2',
        tags: ['ÊóÖË°å', 'Êò•ËäÇ'],
        created_at: '2024-01-09T21:00:00Z',
        updated_at: '2024-01-09T21:00:00Z'
      }
    ]

    setFolders(mockFolders)
    setNotes(mockNotes)
    
    // ÈªòËÆ§Â±ïÂºÄÁ¨¨‰∏Ä‰∏™Êñá‰ª∂Â§π
    if (mockFolders[selectedCategory] && mockFolders[selectedCategory].length > 0) {
      setExpandedFolders({ [mockFolders[selectedCategory][0].id]: true })
    }
  }

  // Ëé∑ÂèñÂΩìÂâçÂàÜÁ±ªÁöÑÁ¨îËÆ∞
  const getCurrentCategoryNotes = () => {
    return notes.filter(note => note.category === selectedCategory)
  }

  // ÊêúÁ¥¢ËøáÊª§Á¨îËÆ∞
  const getFilteredNotes = () => {
    const categoryNotes = getCurrentCategoryNotes()
    if (!searchTerm) return categoryNotes
    
    return categoryNotes.filter(note =>
      note.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
      note.content.toLowerCase().includes(searchTerm.toLowerCase()) ||
      note.tags.some(tag => tag.toLowerCase().includes(searchTerm.toLowerCase()))
    )
  }

  // ÂàáÊç¢Êñá‰ª∂Â§πÂ±ïÂºÄÁä∂ÊÄÅ
  const toggleFolder = (folderId) => {
    setExpandedFolders(prev => ({
      ...prev,
      [folderId]: !prev[folderId]
    }))
  }

  // ÂàõÂª∫Êñ∞Á¨îËÆ∞
  const createNewNote = () => {
    const newNote = {
      id: `n${Date.now()}`,
      title: 'Êñ∞Á¨îËÆ∞',
      content: '',
      category: selectedCategory,
      folder: folders[selectedCategory]?.[0]?.id || null,
      tags: [],
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString()
    }
    
    setNotes([newNote, ...notes])
    setSelectedNote(newNote)
    setIsEditing(true)
    setEditingNote({ ...newNote })
  }

  // ‰øùÂ≠òÁ¨îËÆ∞
  const saveNote = async () => {
    if (!editingNote) return
    
    try {
      // ËøôÈáåÂ∫îËØ•Ë∞ÉÁî®API‰øùÂ≠òÁ¨îËÆ∞
      // const response = await fetch(`/api/notes/${editingNote.id}`, {
      //   method: 'PUT',
      //   headers: { 'Content-Type': 'application/json' },
      //   body: JSON.stringify(editingNote)
      // })
      
      // Êõ¥Êñ∞Êú¨Âú∞Áä∂ÊÄÅ
      setNotes(notes.map(note => 
        note.id === editingNote.id 
          ? { ...editingNote, updated_at: new Date().toISOString() }
          : note
      ))
      
      setSelectedNote(editingNote)
      setIsEditing(false)
      setEditingNote(null)
    } catch (error) {
      console.error('‰øùÂ≠òÁ¨îËÆ∞Â§±Ë¥•:', error)
      alert('‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑ÈáçËØï')
    }
  }

  // Âà†Èô§Á¨îËÆ∞
  const deleteNote = async (noteId) => {
    if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÁØáÁ¨îËÆ∞ÂêóÔºü')) return
    
    try {
      // ËøôÈáåÂ∫îËØ•Ë∞ÉÁî®APIÂà†Èô§Á¨îËÆ∞
      // await fetch(`/api/notes/${noteId}`, { method: 'DELETE' })
      
      setNotes(notes.filter(note => note.id !== noteId))
      if (selectedNote?.id === noteId) {
        setSelectedNote(null)
      }
    } catch (error) {
      console.error('Âà†Èô§Á¨îËÆ∞Â§±Ë¥•:', error)
      alert('Âà†Èô§Â§±Ë¥•ÔºåËØ∑ÈáçËØï')
    }
  }

  // AIÂ¢ûÂº∫ÊñáÊú¨
  const enhanceWithAI = async () => {
    if (!editingNote?.content) {
      alert('ËØ∑ÂÖàËæìÂÖ•‰∏Ä‰∫õÂÜÖÂÆπ')
      return
    }
    
    setIsAIProcessing(true)
    
    try {
      const response = await fetch('/api/ai/enhance-text', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          text: editingNote.content,
          mode: aiMode,
          model: aiModel
        })
      })
      
      if (!response.ok) {
        throw new Error('AIÂ¢ûÂº∫Â§±Ë¥•')
      }
      
      const data = await response.json()
      
      setEditingNote({
        ...editingNote,
        content: data.enhanced_text
      })
      
      setShowAIModal(false)
    } catch (error) {
      console.error('AIÂ¢ûÂº∫Â§±Ë¥•:', error)
      alert('AIÂ¢ûÂº∫Â§±Ë¥•ÔºåËØ∑ÈáçËØï')
    } finally {
      setIsAIProcessing(false)
    }
  }

  // ÁîüÊàêÊô∫ËÉΩÊ†áÁ≠æ
  const generateTags = async () => {
    if (!editingNote?.title && !editingNote?.content) return
    
    try {
      const response = await fetch('/api/ai/generate-tags', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          title: editingNote.title,
          content: editingNote.content,
          model: aiModel
        })
      })
      
      if (response.ok) {
        const data = await response.json()
        setEditingNote({
          ...editingNote,
          tags: [...new Set([...editingNote.tags, ...data.tags])]
        })
      }
    } catch (error) {
      console.error('ÁîüÊàêÊ†áÁ≠æÂ§±Ë¥•:', error)
    }
  }

  const currentCategory = categories.find(cat => cat.id === selectedCategory)
  const filteredNotes = getFilteredNotes()

  return (
    <div className="h-[calc(100vh-4rem)] flex flex-col lg:flex-row">
      {/* ÁßªÂä®Á´ØÈ°∂ÈÉ®Ê†è */}
      <div className="lg:hidden flex items-center justify-between p-4 border-b border-border bg-background">
        <h1 className="text-lg font-semibold">Á¨îËÆ∞</h1>
        <Button
          onClick={createNewNote}
          size="sm"
          className="eva-button"
        >
          <Plus className="w-4 h-4 mr-2" />
          Êñ∞Âª∫
        </Button>
      </div>

      {/* Â∑¶‰æßËæπÊ†è */}
      <div className="w-full lg:w-80 eva-panel m-2 lg:m-4 lg:mr-2 flex flex-col max-h-[40vh] lg:max-h-none overflow-hidden">
        {/* ÂàÜÁ±ªÊ†áÁ≠æ */}
        <div className="p-3 lg:p-4 border-b border-border">
          <div className="flex flex-wrap gap-1 lg:gap-2">
            {categories.map(category => (
              <Badge
                key={category.id}
                variant={selectedCategory === category.id ? "default" : "secondary"}
                className={`cursor-pointer text-xs lg:text-sm ${selectedCategory === category.id ? category.color : ''}`}
                onClick={() => setSelectedCategory(category.id)}
              >
                {category.name}
              </Badge>
            ))}
          </div>
        </div>

        {/* ÊêúÁ¥¢ÂíåÊñ∞Âª∫ */}
        <div className="p-3 lg:p-4 border-b border-border">
          <div className="flex gap-2 mb-3">
            <div className="flex-1 relative">
              <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground w-4 h-4" />
              <Input
                placeholder="ÊêúÁ¥¢Á¨îËÆ∞..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                className="eva-input pl-10 h-9 lg:h-10"
              />
            </div>
          </div>
          <div className="flex gap-2">
            <Button
              onClick={createNewNote}
              className="eva-button flex-1 h-9 lg:h-10 text-sm hidden lg:flex"
            >
              <Plus className="w-4 h-4 mr-2" />
              Êñ∞Âª∫Á¨îËÆ∞
            </Button>
            <Button
              onClick={createNewNote}
              className="eva-button flex-1 h-9 text-sm lg:hidden"
            >
              <Plus className="w-4 h-4 mr-1" />
              Êñ∞Âª∫
            </Button>
            <Button
              variant="outline"
              className="eva-button-outline h-9 lg:h-10"
            >
              <FolderPlus className="w-4 h-4" />
            </Button>
          </div>
        </div>

        {/* Êñá‰ª∂Â§πÂíåÁ¨îËÆ∞ÂàóË°® */}
        <div className="flex-1 overflow-y-auto">
          {folders[selectedCategory]?.map(folder => (
            <div key={folder.id} className="border-b border-border">
              <button
                onClick={() => toggleFolder(folder.id)}
                className="w-full flex items-center gap-2 p-2 lg:p-3 hover:bg-muted text-left"
              >
                {expandedFolders[folder.id] ? (
                  <ChevronDown className="w-4 h-4" />
                ) : (
                  <ChevronRight className="w-4 h-4" />
                )}
                <span className="font-medium text-sm lg:text-base truncate">{folder.name}</span>
                <span className="ml-auto text-xs text-muted-foreground">
                  {folder.notes.length}
                </span>
              </button>
              
              {expandedFolders[folder.id] && (
                <div className="pb-2">
                  {filteredNotes
                    .filter(note => note.folder === folder.id)
                    .map(note => (
                      <button
                        key={note.id}
                        onClick={() => setSelectedNote(note)}
                        className={`w-full text-left p-2 lg:p-3 pl-6 lg:pl-8 hover:bg-muted border-l-2 transition-colors ${
                          selectedNote?.id === note.id
                            ? 'border-l-primary bg-muted'
                            : 'border-l-transparent'
                        }`}
                      >
                        <div className="flex items-start gap-2">
                          <FileText className="w-4 h-4 mt-0.5 text-muted-foreground flex-shrink-0" />
                          <div className="flex-1 min-w-0">
                            <div className="font-medium text-sm lg:text-base truncate">
                              {note.title}
                            </div>
                            <div className="text-xs lg:text-sm text-muted-foreground mt-1 line-clamp-2">
                              {note.content}
                            </div>
                            {note.tags.length > 0 && (
                              <div className="flex gap-1 mt-2">
                                {note.tags.slice(0, 2).map(tag => (
                                  <Badge key={tag} variant="secondary" className="text-xs">
                                    {tag}
                                  </Badge>
                                ))}
                                {note.tags.length > 2 && (
                                  <Badge variant="secondary" className="text-xs">
                                    +{note.tags.length - 2}
                                  </Badge>
                                )}
                              </div>
                            )}
                          </div>
                        </div>
                      </button>
                    ))}
                </div>
              )}
            </div>
          ))}
        </div>
      </div>

      {/* Âè≥‰æßÂÜÖÂÆπÂå∫ */}
      <div className="flex-1 eva-panel m-2 lg:m-4 lg:ml-2 flex flex-col">
        {selectedNote ? (
          <>
            {/* Á¨îËÆ∞Â§¥ÈÉ® */}
            <div className="p-3 lg:p-4 border-b border-border">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-2 lg:gap-3 min-w-0 flex-1">
                  <div className={`w-3 h-3 rounded-full ${currentCategory?.color} flex-shrink-0`}></div>
                  <h2 className="text-lg lg:text-xl font-bold truncate">
                    {isEditing ? (
                      <Input
                        value={editingNote?.title || ''}
                        onChange={(e) => setEditingNote({
                          ...editingNote,
                          title: e.target.value
                        })}
                        className="eva-input text-lg lg:text-xl font-bold"
                      />
                    ) : (
                      selectedNote.title
                    )}
                  </h2>
                </div>
                
                <div className="flex items-center gap-1 lg:gap-2 flex-shrink-0">
                  {isEditing ? (
                    <>
                      <Button
                        onClick={() => setShowAIModal(true)}
                        variant="outline"
                        size="sm"
                        className="text-primary hidden lg:flex"
                      >
                        <Brain className="w-4 h-4 mr-2" />
                        AIÂ¢ûÂº∫
                      </Button>
                      <Button
                        onClick={() => setShowAIModal(true)}
                        variant="outline"
                        size="sm"
                        className="text-primary lg:hidden"
                      >
                        <Brain className="w-4 h-4" />
                      </Button>
                      <Button
                        onClick={generateTags}
                        variant="outline"
                        size="sm"
                        className="hidden lg:flex"
                      >
                        <Tag className="w-4 h-4 mr-2" />
                        ÁîüÊàêÊ†áÁ≠æ
                      </Button>
                      <Button
                        onClick={generateTags}
                        variant="outline"
                        size="sm"
                        className="lg:hidden"
                      >
                        <Tag className="w-4 h-4" />
                      </Button>
                      <Button onClick={saveNote} className="eva-button" size="sm">
                        <Save className="w-4 h-4 mr-1 lg:mr-2" />
                        <span className="hidden lg:inline">‰øùÂ≠ò</span>
                      </Button>
                      <Button
                        onClick={() => {
                          setIsEditing(false)
                          setEditingNote(null)
                        }}
                        variant="outline"
                        size="sm"
                      >
                        <X className="w-4 h-4" />
                      </Button>
                    </>
                  ) : (
                    <>
                      <Button
                        onClick={() => {
                          setIsEditing(true)
                          setEditingNote({ ...selectedNote })
                        }}
                        variant="outline"
                        size="sm"
                      >
                        <Edit3 className="w-4 h-4 mr-1 lg:mr-2" />
                        <span className="hidden lg:inline">ÁºñËæë</span>
                      </Button>
                      <Button
                        onClick={() => deleteNote(selectedNote.id)}
                        variant="outline"
                        size="sm"
                        className="text-destructive hover:text-destructive"
                      >
                        <Trash2 className="w-4 h-4" />
                      </Button>
                    </>
                  )}
                </div>
              </div>
              
              {/* Ê†áÁ≠æ */}
              <div className="flex items-center gap-1 lg:gap-2 mt-3 flex-wrap">
                {(isEditing ? editingNote?.tags : selectedNote.tags)?.map(tag => (
                  <Badge key={tag} variant="secondary" className="text-xs lg:text-sm">
                    {tag}
                    {isEditing && (
                      <button
                        onClick={() => setEditingNote({
                          ...editingNote,
                          tags: editingNote.tags.filter(t => t !== tag)
                        })}
                        className="ml-1 hover:text-destructive"
                      >
                        <X className="w-3 h-3" />
                      </button>
                    )}
                  </Badge>
                ))}
              </div>
            </div>

            {/* Á¨îËÆ∞ÂÜÖÂÆπ */}
            <div className="flex-1 p-3 lg:p-4 overflow-hidden">
              {isEditing ? (
                <Textarea
                  value={editingNote?.content || ''}
                  onChange={(e) => setEditingNote({
                    ...editingNote,
                    content: e.target.value
                  })}
                  placeholder="ÂºÄÂßãÂÜô‰Ωú..."
                  className="eva-input w-full h-full resize-none text-sm lg:text-base"
                />
              ) : (
                <div className="prose prose-sm lg:prose-base max-w-none overflow-y-auto">
                  {selectedNote.content.split('\n').map((line, index) => (
                    <p key={index} className="mb-2 text-sm lg:text-base">
                      {line || '\u00A0'}
                    </p>
                  ))}
                </div>
              )}
            </div>
          </>
        ) : (
          <div className="flex-1 flex items-center justify-center text-muted-foreground p-4">
            <div className="text-center">
              <FileText className="w-12 h-12 lg:w-16 lg:h-16 mx-auto mb-4 opacity-50" />
              <p className="text-base lg:text-lg">ÈÄâÊã©‰∏ÄÁØáÁ¨îËÆ∞ÂºÄÂßãÈòÖËØª</p>
              <p className="text-sm lg:text-base mt-2">ÊàñËÄÖÂàõÂª∫‰∏ÄÁØáÊñ∞Á¨îËÆ∞</p>
            </div>
          </div>
        )}
      </div>

      {/* AIÂ¢ûÂº∫ÂºπÁ™ó */}
      {showAIModal && (
        <Dialog open={showAIModal} onOpenChange={setShowAIModal}>
          <DialogContent className="max-w-md">
            <DialogHeader>
              <DialogTitle className="flex items-center gap-2">
                <Brain className="w-5 h-5 text-primary" />
                AIÊñáÊú¨Â¢ûÂº∫
              </DialogTitle>
            </DialogHeader>
            
            <div className="space-y-4">
              {/* AIÊ®°ÂûãÈÄâÊã© */}
              <div className="space-y-2">
                <label className="text-sm font-medium">AIÊ®°Âûã</label>
                <Select value={aiModel} onValueChange={setAiModel}>
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    {availableModels.map(model => (
                      <SelectItem key={model.id} value={model.id}>
                        <div className="flex items-center gap-2">
                          <div className={`w-2 h-2 rounded-full ${model.color}`}></div>
                          <span>{model.name}</span>
                        </div>
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>

              {/* Â¢ûÂº∫Ê®°ÂºèÈÄâÊã© */}
              <div className="space-y-2">
                <label className="text-sm font-medium">Â¢ûÂº∫Ê®°Âºè</label>
                <div className="grid grid-cols-1 gap-2">
                  {aiModes.map(mode => (
                    <button
                      key={mode.id}
                      onClick={() => setAiMode(mode.id)}
                      className={`p-3 text-left rounded-lg border transition-colors ${
                        aiMode === mode.id
                          ? 'border-primary bg-primary/10'
                          : 'border-border hover:bg-muted'
                      }`}
                    >
                      <div className="font-medium text-sm">{mode.name}</div>
                      <div className="text-xs text-muted-foreground">{mode.description}</div>
                    </button>
                  ))}
                </div>
              </div>

              {/* Êìç‰ΩúÊåâÈíÆ */}
              <div className="flex justify-between pt-4">
                <Button variant="outline" onClick={() => setShowAIModal(false)}>
                  ÂèñÊ∂à
                </Button>
                <Button 
                  onClick={enhanceWithAI} 
                  disabled={isAIProcessing}
                  className="eva-button"
                >
                  {isAIProcessing ? (
                    <>
                      <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                      Â§ÑÁêÜ‰∏≠...
                    </>
                  ) : (
                    <>
                      <Wand2 className="w-4 h-4 mr-2" />
                      ÂºÄÂßãÂ¢ûÂº∫
                    </>
                  )}
                </Button>
              </div>
            </div>
          </DialogContent>
        </Dialog>
      )}
    </div>
  )
}

export default NotesPageFinal

